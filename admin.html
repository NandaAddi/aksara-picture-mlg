<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Aksara Admin Panel</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Manrope', 'sans-serif'],
                        serif: ['Playfair Display', 'serif'],
                    },
                    colors: {
                        'studio-black': '#050505',
                        'studio-gray': '#121212',
                        'studio-card': '#1a1a1a',
                        'studio-white': '#f5f5f5',
                        'studio-gold': '#d4af37',
                        'studio-gold-light': '#f3cf55',
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-out forwards',
                        'slide-up': 'slideUp 0.5s ease-out forwards',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        slideUp: {
                            '0%': { opacity: '0', transform: 'translateY(20px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        }
                    }
                }
            }
        };
    </script>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;500;600&family=Playfair+Display:ital,wght@0,400;0,500;0,600;1,400&display=swap" rel="stylesheet">
    
    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-track { background: #050505; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #d4af37; }
        
        body {
            background-color: #050505;
            background-image: radial-gradient(circle at 50% 0%, #1a1a1a 0%, #050505 70%);
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.5);
        }

        .admin-input {
            width: 100%; 
            background-color: transparent; 
            border-bottom: 1px solid rgba(255, 255, 255, 0.15);
            padding: 12px 0; 
            color: white; 
            transition: all 0.3s ease;
            font-size: 0.95rem;
            border-radius: 0; /* Mobile fix */
        }
        .admin-input:focus { 
            border-bottom-color: #d4af37; 
            outline: none; 
            padding-left: 8px; 
        }
        .admin-input::placeholder { color: #444; font-weight: 300; }
        
        .drag-handle { cursor: grab; color: #444; transition: color 0.2s; touch-action: none; } /* Touch action fix */
        .drag-handle:hover { color: #d4af37; cursor: grabbing; }
        .sortable-ghost { opacity: 0.2; background-color: #d4af37 !important; }
        
        /* Hide scrollbar for horiz nav on mobile */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        
    </style>
</head>
<body id="mainBody" class="text-studio-white font-sans h-screen overflow-hidden flex flex-col justify-center selection:bg-studio-gold selection:text-black" style="display: none;">

    <div id="loginScreen" class="w-[90%] md:w-full max-w-md mx-auto glass-panel p-6 md:p-10 rounded-2xl shadow-2xl animate-slide-up z-50 relative overflow-hidden">
        <div class="absolute top-0 left-1/2 -translate-x-1/2 w-32 h-1 bg-gradient-to-r from-transparent via-studio-gold to-transparent opacity-50"></div>
        <div class="text-center mb-8 md:mb-10">
            <h1 class="font-serif text-3xl md:text-4xl italic text-white mb-2 tracking-wide">Aksara<span class="text-studio-gold">.</span></h1>
            <p class="text-[10px] text-gray-500 uppercase tracking-[0.3em]">Authorized Personnel Only</p>
        </div>
        <div class="space-y-6">
            <div class="group">
                <label class="block text-[10px] uppercase tracking-widest text-studio-gold mb-1 font-bold opacity-70">Email Access</label>
                <input type="email" id="emailInput" class="admin-input" placeholder="admin@aksarapicture.com">
            </div>
            <button id="btnLogin" onclick="handleLogin()" class="w-full bg-gradient-to-r from-studio-gold to-[#bfa030] text-black py-4 px-6 text-xs uppercase tracking-widest font-bold hover:shadow-[0_0_20px_rgba(212,175,55,0.3)] transition-all rounded-lg active:scale-95">
                Send Magic Link
            </button>
        </div>
        <p id="loginStatus" class="text-center text-xs mt-8 text-gray-600 font-medium"></p>
    </div>

    <div id="dashboardLayout" class="hidden w-full h-screen flex-col md:flex-row">
        
        <aside class="w-full md:w-72 bg-studio-black/90 backdrop-blur-xl border-b md:border-b-0 md:border-r border-white/5 flex flex-col md:justify-between p-4 md:p-8 z-40 shrink-0">
            
            <div class="flex md:block items-center justify-between mb-4 md:mb-12">
                <div class="flex items-center gap-3 md:gap-4">
                    <div class="w-8 h-8 md:w-10 md:h-10 rounded-xl bg-gradient-to-br from-studio-gold to-[#8f7520] flex items-center justify-center text-black font-serif italic font-bold text-lg md:text-xl shadow-lg">A</div>
                    <div>
                        <span class="font-serif italic text-xl md:text-2xl text-white block leading-none">Aksara.</span>
                        <span class="text-[8px] md:text-[9px] text-gray-500 uppercase tracking-widest hidden md:block">Admin Panel</span>
                    </div>
                </div>
                <button onclick="handleLogout()" class="md:hidden text-gray-400 p-2"><i class="fa-solid fa-power-off"></i></button>
            </div>

            <nav class="flex flex-row md:flex-col gap-2 md:gap-3 overflow-x-auto no-scrollbar pb-2 md:pb-0 w-full">
                <button onclick="switchTab('portfolio')" id="nav-portfolio" class="nav-btn whitespace-nowrap flex-shrink-0 w-auto md:w-full text-left py-3 px-4 md:py-4 md:px-5 rounded-xl text-xs md:text-sm font-medium transition-all flex items-center gap-2 md:gap-4 bg-white/5 text-studio-gold border border-studio-gold/20 shadow-lg">
                    <i class="fa-solid fa-camera-retro md:w-5 text-center"></i> 
                    <span class="tracking-wide">Portfolio</span>
                </button>
                <button onclick="switchTab('linktree')" id="nav-linktree" class="nav-btn whitespace-nowrap flex-shrink-0 w-auto md:w-full text-left py-3 px-4 md:py-4 md:px-5 rounded-xl text-xs md:text-sm font-medium text-gray-500 hover:text-white hover:bg-white/5 transition-all flex items-center gap-2 md:gap-4">
                    <i class="fa-solid fa-link md:w-5 text-center"></i> 
                    <span class="tracking-wide">LinkBio</span>
                </button>
                <button onclick="switchTab('popup')" id="nav-popup" class="nav-btn whitespace-nowrap flex-shrink-0 w-auto md:w-full text-left py-3 px-4 md:py-4 md:px-5 rounded-xl text-xs md:text-sm font-medium text-gray-500 hover:text-white hover:bg-white/5 transition-all flex items-center gap-2 md:gap-4">
                    <i class="fa-regular fa-window-restore md:w-5 text-center"></i> 
                    <span class="tracking-wide">Popup</span>
                </button>
                <button onclick="switchTab('converter')" id="nav-converter" class="nav-btn whitespace-nowrap flex-shrink-0 w-auto md:w-full text-left py-3 px-4 md:py-4 md:px-5 rounded-xl text-xs md:text-sm font-medium text-gray-500 hover:text-white hover:bg-white/5 transition-all flex items-center gap-2 md:gap-4">
                    <i class="fa-solid fa-wand-magic-sparkles md:w-5 text-center"></i> 
                    <span class="tracking-wide">WebP Converter</span>
                </button>
                <button onclick="switchTab('shortlink')" id="nav-shortlink" class="nav-btn whitespace-nowrap flex-shrink-0 w-auto md:w-full text-left py-3 px-4 md:py-4 md:px-5 rounded-xl text-xs md:text-sm font-medium text-gray-500 hover:text-white hover:bg-white/5 transition-all flex items-center gap-2 md:gap-4">
                    <i class="fa-solid fa-share-nodes md:w-5 text-center"></i> 
                    <span class="tracking-wide">Shortlinks</span>
                </button>
            </nav>

            <div class="hidden md:block mt-8 pt-8 border-t border-white/5">
                <button onclick="handleLogout()" class="w-full text-left py-3 px-2 rounded-lg text-xs font-bold text-gray-600 hover:text-red-400 transition-all flex items-center gap-3 group">
                    <i class="fa-solid fa-power-off w-5 text-center group-hover:scale-110 transition-transform"></i> Logout Access
                </button>
                <p class="text-[9px] text-gray-700 mt-6 px-2 font-mono">Build v2.4 stable</p>
            </div>
        </aside>

        <main class="flex-1 overflow-y-auto relative p-4 md:p-12 scroll-smooth bg-studio-black">
            
            <div id="section-portfolio" class="section-content max-w-6xl mx-auto animate-fade-in pb-20 md:pb-24">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-end mb-8 md:mb-10 border-b border-white/5 pb-4 md:pb-6 gap-2">
                    <div>
                        <h1 class="font-serif text-3xl md:text-4xl italic text-white mb-1 md:mb-2">Portfolio Manager</h1>
                        <p class="text-[10px] md:text-xs text-studio-gold uppercase tracking-[0.2em]">Curate your masterpieces</p>
                    </div>
                </div>
                
                <div class="glass-panel p-5 md:p-8 rounded-2xl mb-8 md:mb-12">
                    <h2 class="font-serif text-xl md:text-2xl italic mb-6 md:mb-8 text-gray-200 flex items-center gap-3">
                        <span class="w-1.5 h-1.5 md:w-2 md:h-2 bg-studio-gold rounded-full"></span> New Project
                    </h2>
                    <form id="uploadForm" class="space-y-6 md:space-y-8">
                        <div class="group">
                            <label class="block text-[10px] uppercase tracking-widest text-gray-500 mb-1 font-bold">Project Title</label>
                            <input type="text" id="title" class="admin-input" placeholder="e.g. Hilman's Grads" required>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 md:gap-8">
                            <div class="group">
                                <label class="block text-[10px] uppercase tracking-widest text-gray-500 mb-1 font-bold">Slug</label>
                                <input type="text" id="slug" class="admin-input" placeholder="hilman-grad" required>
                            </div>
                            <div class="group">
                                <label class="block text-[10px] uppercase tracking-widest text-gray-500 mb-1 font-bold">Category</label>
                                <div class="relative">
                                    <select id="category" class="admin-input cursor-pointer bg-studio-black">
                                        <option value="Graduation">Graduation</option>
                                        <option value="Wedding">Wedding</option>
                                        <option value="Others">Others</option>
                                    </select>
                                    <i class="fa-solid fa-chevron-down absolute right-2 top-1/2 -translate-y-1/2 text-[10px] text-studio-gold pointer-events-none"></i>
                                </div>
                            </div>
                        </div>
                        
                        <div class="relative group">
                            <input type="file" id="photos" multiple accept="image/*" class="hidden" onchange="updateFileName(this)">
                            <label for="photos" class="cursor-pointer block w-full border border-dashed border-white/10 bg-white/[0.02] rounded-xl p-6 md:p-10 text-center hover:border-studio-gold/50 hover:bg-studio-gold/5 transition-all">
                                <i class="fa-solid fa-cloud-arrow-up text-xl md:text-2xl text-gray-400 group-hover:text-studio-gold mb-3 transition-colors"></i>
                                <p class="text-xs md:text-sm text-gray-300 font-medium mb-1" id="fileLabel">Tap to select photos</p>
                            </label>
                        </div>

                        <div class="flex flex-col-reverse md:flex-row items-center justify-between gap-4 pt-2 md:pt-4">
                            <p id="status" class="text-[10px] md:text-xs text-studio-gold font-bold animate-pulse"></p>
                            <button type="submit" id="btnSubmit" class="w-full md:w-auto bg-white text-black py-3 px-8 text-xs uppercase font-bold hover:bg-studio-gold hover:text-white transition-all rounded-lg shadow-lg tracking-widest">
                                Publish Portfolio
                            </button>
                        </div>
                    </form>
                </div>

                <div class="glass-panel p-1 rounded-2xl overflow-hidden">
                    <div class="p-4 md:p-8 md:pb-4 flex justify-between items-center border-b border-white/5 bg-white/[0.01]">
                        <h2 class="font-serif text-lg md:text-xl italic text-gray-300">Existing Projects</h2>
                        <button onclick="loadProjectList()" class="text-[9px] md:text-[10px] text-studio-gold border border-studio-gold/30 px-3 py-1.5 rounded hover:bg-studio-gold hover:text-black transition-colors uppercase tracking-widest">
                            <i class="fa-solid fa-rotate mr-1"></i> Refresh
                        </button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left text-sm text-gray-400 min-w-[500px]"> <thead class="bg-white/[0.02] text-gray-500 uppercase text-[9px] tracking-widest font-bold">
                                <tr>
                                    <th class="px-3 py-3 md:px-6 md:py-4 w-10 text-center">#</th> 
                                    <th class="px-3 py-3 md:px-6 md:py-4">Date</th>
                                    <th class="px-3 py-3 md:px-6 md:py-4">Project Details</th>
                                    <th class="px-3 py-3 md:px-6 md:py-4 text-right">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="projectTableBody" class="divide-y divide-white/5 bg-transparent"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="section-linktree" class="section-content hidden max-w-5xl mx-auto animate-fade-in pb-20 md:pb-24">
                <div class="mb-8 md:mb-10 border-b border-white/5 pb-6">
                    <h1 class="font-serif text-3xl md:text-4xl italic text-white mb-2">LinkBio Manager</h1>
                    <p class="text-xs text-studio-gold uppercase tracking-[0.2em]">Social & External Links</p>
                </div>
                
                <div class="glass-panel p-5 md:p-8 rounded-2xl mb-8 md:mb-12 border-t-4 border-t-studio-gold relative overflow-hidden">
                    <div class="absolute top-0 right-0 p-4 opacity-10 pointer-events-none">
                        <i class="fa-solid fa-link text-6xl md:text-8xl text-white"></i>
                    </div>
                    <h2 class="font-serif text-xl italic mb-6 text-gray-300">Add New Destination</h2>
                    <form id="linkForm" class="space-y-6 relative z-10">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="group">
                                <label class="block text-[10px] uppercase tracking-widest text-gray-500 mb-1 font-bold">Label (ID)</label>
                                <input type="text" id="linkLabelID" class="admin-input" placeholder="Website Kami" required>
                            </div>
                            <div class="group">
                                <label class="block text-[10px] uppercase tracking-widest text-gray-500 mb-1 font-bold">Label (EN)</label>
                                <input type="text" id="linkLabelEN" class="admin-input" placeholder="Our Website" required>
                            </div>
                            <div class="md:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="group">
                                    <label class="block text-[10px] uppercase tracking-widest text-gray-500 mb-1 font-bold">URL Destination</label>
                                    <input type="url" id="linkURL" class="admin-input text-studio-gold" placeholder="https://..." required>
                                </div>
                                <div class="group">
                                    <label class="block text-[10px] uppercase tracking-widest text-gray-500 mb-1 font-bold">FontAwesome Class</label>
                                    <input type="text" id="linkIcon" class="admin-input" placeholder="fa-brands fa-instagram" required>
                                </div>
                            </div>
                        </div>
                        <div class="pt-2">
                            <button type="submit" class="w-full md:w-auto bg-white/10 text-white py-3 px-6 text-xs uppercase font-bold hover:bg-studio-gold hover:text-black transition-all rounded-lg border border-white/10 flex items-center justify-center gap-2">
                                <i class="fa-solid fa-plus"></i> Add to List
                            </button>
                        </div>
                    </form>
                </div>

                <div class="glass-panel p-1 rounded-2xl overflow-hidden">
                    <div class="p-4 md:p-6 flex justify-between items-center border-b border-white/5">
                        <h2 class="font-serif text-lg md:text-xl italic text-gray-300">Active Links</h2>
                        <button onclick="loadLinks()" class="text-xs text-studio-gold hover:text-white transition-colors"><i class="fa-solid fa-rotate"></i></button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left text-sm text-gray-400 min-w-[500px]">
                            <thead class="bg-white/[0.02] text-gray-500 uppercase text-[9px] tracking-widest font-bold">
                                <tr>
                                    <th class="px-3 py-3 md:px-6 md:py-4 w-10 text-center">#</th>
                                    <th class="px-3 py-3 md:px-6 md:py-4">Link Label</th>
                                    <th class="px-3 py-3 md:px-6 md:py-4">URL</th>
                                    <th class="px-3 py-3 md:px-6 md:py-4 text-right">Action</th>
                                </tr>
                            </thead>
                            <tbody id="linkTableBody" class="divide-y divide-white/5 bg-transparent"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="section-popup" class="section-content hidden max-w-6xl mx-auto animate-fade-in pb-20 md:pb-24">
                <div class="mb-8 md:mb-10 border-b border-white/5 pb-6">
                    <h1 class="font-serif text-3xl md:text-4xl italic text-white mb-2">Popup Promo</h1>
                    <p class="text-xs text-studio-gold uppercase tracking-[0.2em]">Front-page Announcement</p>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8 md:gap-12">
                    <div class="glass-panel p-5 md:p-8 rounded-2xl h-fit order-2 md:order-1">
                        <h2 class="font-serif text-xl md:text-2xl italic mb-6 md:mb-8 text-gray-300">Update Content</h2>
                        <form id="popupForm" class="space-y-6">
                            <div class="group">
                                <label class="block text-[10px] uppercase tracking-widest text-gray-500 mb-1 font-bold">Campaign Title</label>
                                <input type="text" id="popTitle" class="admin-input" placeholder="New Season Open" required>
                            </div>
                            <div class="group">
                                <label class="block text-[10px] uppercase tracking-widest text-gray-500 mb-1 font-bold">Small Badge Tag</label>
                                <input type="text" id="popTag" class="admin-input" placeholder="BOOKING 2026" required>
                            </div>
                            <div class="group">
                                <label class="block text-[10px] uppercase tracking-widest text-gray-500 mb-1 font-bold">Description Text</label>
                                <textarea id="popDesc" rows="3" class="admin-input resize-none" placeholder="Explain the promo..." required></textarea>
                            </div>
                            <div class="group">
                                <label class="block text-[10px] uppercase tracking-widest text-gray-500 mb-2 font-bold">Background Visual</label>
                                <input type="file" id="popImage" accept="image/*" class="text-gray-400 text-xs w-full bg-black/20 border border-white/10 p-3 rounded-lg focus:border-studio-gold outline-none transition-colors">
                            </div>
                            
                            <div class="pt-4">
                                <button type="submit" id="btnPopSubmit" class="w-full bg-white text-black py-4 text-xs uppercase tracking-[0.2em] font-bold hover:bg-studio-gold hover:text-white transition-all duration-300 rounded-lg shadow-lg">
                                    Set Active Popup
                                </button>
                                <p id="popStatus" class="text-center text-[10px] mt-3 text-studio-gold font-mono"></p>
                            </div>
                        </form>
                    </div>

                    <div class="flex flex-col order-1 md:order-2">
                        <div class="glass-panel p-6 md:p-8 rounded-2xl flex flex-col items-center justify-center text-center h-fit md:sticky md:top-6">
                            <h2 class="font-serif text-lg md:text-xl italic mb-6 md:mb-8 text-gray-300 flex items-center gap-2">
                                <i class="fa-regular fa-eye text-sm"></i> Live Preview
                            </h2>
                            
                            <div class="relative p-2 bg-studio-gray border border-white/10 rounded-[2rem] shadow-2xl max-w-[200px] md:max-w-none mx-auto">
                                <div id="currentPopPreview" class="w-full md:w-64 aspect-[3/4] bg-black rounded-[1.8rem] relative overflow-hidden bg-cover bg-center border border-white/5 shadow-inner transition-all duration-500 group cursor-default">
                                    <div class="absolute inset-0 bg-gradient-to-t from-black via-black/40 to-transparent opacity-90"></div>
                                    <div class="absolute top-4 right-4 md:top-6 md:right-6 bg-white/10 backdrop-blur-md border border-white/20 px-2 py-1 md:px-3 md:py-1.5 rounded-full text-[8px] text-white font-bold tracking-widest shadow-lg" id="prevTag">TAG</div>
                                    <div class="absolute bottom-0 left-0 w-full p-4 md:p-6 text-left transform translate-y-0 md:translate-y-2 md:group-hover:translate-y-0 transition-transform duration-500">
                                        <div class="w-6 h-1 md:w-8 bg-studio-gold mb-2 md:mb-3 rounded-full"></div>
                                        <h3 class="font-serif text-white text-lg md:text-2xl italic leading-none mb-1 md:mb-2" id="prevTitle">Title</h3>
                                        <p class="text-gray-300 text-[9px] md:text-[10px] leading-relaxed opacity-80" id="prevDesc">Description...</p>
                                    </div>
                                </div>
                            </div>
                            <p class="text-[9px] text-gray-600 mt-6 md:mt-8 uppercase tracking-widest">Visual representation</p>
                        </div>
                    </div>
                </div>
            </div>


            <div id="section-converter" class="section-content hidden max-w-4xl mx-auto animate-fade-in pb-20 md:pb-24">
                <div class="mb-8 md:mb-10 border-b border-white/5 pb-6">
                    <h1 class="font-serif text-3xl md:text-4xl italic text-white mb-2">Image Optimizer</h1>
                    <p class="text-xs text-studio-gold uppercase tracking-[0.2em]">Convert to WebP & Compress</p>
                </div>

                <div class="glass-panel p-6 md:p-10 rounded-2xl">
                    <div class="flex flex-col md:flex-row gap-8">
                        <div class="w-full md:w-1/3 space-y-6 border-r border-white/5 pr-0 md:pr-8">
                            <div class="group">
                                <label class="block text-[10px] uppercase tracking-widest text-gray-500 mb-2 font-bold">Max Width (px)</label>
                                <input type="number" id="convWidth" class="admin-input" value="1920" placeholder="1920">
                                <p class="text-[9px] text-gray-600 mt-1">1920px is standard for web full-screen.</p>
                            </div>
                            <div class="group">
                                <label class="block text-[10px] uppercase tracking-widest text-gray-500 mb-2 font-bold">Quality (0-1)</label>
                                <input type="number" id="convQuality" class="admin-input" value="0.8" step="0.1" max="1" min="0.1">
                                <p class="text-[9px] text-gray-600 mt-1">0.8 is the sweet spot for size vs quality.</p>
                            </div>
                        </div>

                        <div class="w-full md:w-2/3 flex flex-col justify-between">
                            <div class="relative group mb-6">
                                <input type="file" id="convInput" multiple accept="image/*" class="hidden" onchange="updateConvLabel(this)">
                                <label for="convInput" class="cursor-pointer block w-full border border-dashed border-white/10 bg-white/[0.02] rounded-xl p-8 text-center hover:border-studio-gold/50 hover:bg-studio-gold/5 transition-all">
                                    <i class="fa-solid fa-images text-3xl text-gray-400 group-hover:text-studio-gold mb-3 transition-colors"></i>
                                    <p class="text-sm text-gray-300 font-medium mb-1" id="convLabel">Select Images to Convert</p>
                                    <p class="text-[10px] text-gray-600">Supports JPG, PNG, HEIC</p>
                                </label>
                            </div>

                            <div class="space-y-3">
                                <button onclick="processConversion()" id="btnConvert" class="w-full bg-studio-gold text-black py-4 px-6 text-xs uppercase tracking-widest font-bold hover:shadow-[0_0_20px_rgba(212,175,55,0.4)] transition-all rounded-lg hover:scale-[1.01]">
                                    <i class="fa-solid fa-bolt mr-2"></i> Convert & Download ZIP
                                </button>
                                <p id="convStatus" class="text-center text-[10px] text-studio-gold font-mono min-h-[1.5em]"></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="section-shortlink" class="section-content hidden max-w-5xl mx-auto animate-fade-in pb-20 md:pb-24">
                <div class="mb-8 md:mb-10 border-b border-white/5 pb-6">
                    <h1 class="font-serif text-3xl md:text-4xl italic text-white mb-2">Shortlink Manager</h1>
                    <p class="text-xs text-studio-gold uppercase tracking-[0.2em]">Redirect & Analytics</p>
                </div>

                <div class="glass-panel p-5 md:p-8 rounded-2xl mb-8 md:mb-12 border-l-4 border-l-studio-gold">
                    <h2 class="font-serif text-xl italic mb-6 text-gray-300">Create New Shortlink</h2>
                    <form id="shortlinkForm" class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div class="group md:col-span-1">
                                <label class="block text-[10px] uppercase tracking-widest text-gray-500 mb-1 font-bold">Slug (Short)</label>
                                <div class="flex items-center">
                                    <span class="text-gray-600 text-xs mr-2">/</span>
                                    <input type="text" id="slSlug" class="admin-input text-studio-gold font-mono" placeholder="wa-admin" required oninput="this.value = this.value.replace(/[^a-zA-Z0-9-_]/g, '')">
                                </div>
                            </div>
                            <div class="group md:col-span-2">
                                <label class="block text-[10px] uppercase tracking-widest text-gray-500 mb-1 font-bold">Destination URL</label>
                                <input type="url" id="slUrl" class="admin-input" placeholder="https://api.whatsapp.com/send?phone=..." required>
                            </div>
                        </div>
                        <div class="pt-2 flex justify-end">
                            <button type="submit" class="w-full md:w-auto bg-white/10 text-white py-3 px-8 text-xs uppercase font-bold hover:bg-studio-gold hover:text-black transition-all rounded-lg border border-white/10 flex items-center justify-center gap-2">
                                <i class="fa-solid fa-link"></i> Create Link
                            </button>
                        </div>
                    </form>
                </div>

                <div class="glass-panel p-1 rounded-2xl overflow-hidden">
                    <div class="p-4 md:p-6 flex justify-between items-center border-b border-white/5">
                        <h2 class="font-serif text-lg md:text-xl italic text-gray-300">Active Redirects</h2>
                        <button onclick="loadShortlinks()" class="text-xs text-studio-gold hover:text-white transition-colors"><i class="fa-solid fa-rotate"></i></button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left text-sm text-gray-400 min-w-[600px]">
                            <thead class="bg-white/[0.02] text-gray-500 uppercase text-[9px] tracking-widest font-bold">
                                <tr>
                                    <th class="px-3 py-3 md:px-6 md:py-4">Slug</th>
                                    <th class="px-3 py-3 md:px-6 md:py-4">Destination</th>
                                    <th class="px-3 py-3 md:px-6 md:py-4 w-24 text-center">Clicks</th>
                                    <th class="px-3 py-3 md:px-6 md:py-4 text-right">Action</th>
                                </tr>
                            </thead>
                            <tbody id="shortlinkTableBody" class="divide-y divide-white/5 bg-transparent"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

<script>
        // --- CONFIG ---
        const SUPABASE_URL = 'https://rgeshbeiweqnnkbhgoya.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJnZXNoYmVpd2Vxbm5rYmhnb3lhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc2MzcxMTgsImV4cCI6MjA4MzIxMzExOH0.6N7jBP4C0KwHxYA8ymRT1UbN9kTyyQ2O3WV2Umvcdz4';
        
        let sb; 
        try { if(window.supabase) sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY); } catch(e){}

        // --- SECURITY & AUTH (UPDATED) ---
        
        // 1. Cek Sesi Saat Load (Hard Delete Mode)
        async function checkSession() {
            // Tampilkan body setelah JS siap (mencegah blank/flicker)
            const mainBody = document.getElementById('mainBody') || document.body;
            mainBody.style.display = 'flex';
            
            if(!sb) return;

            // Cek session ke server Supabase
            const { data: { session } } = await sb.auth.getSession();
            
            const loginScreen = document.getElementById('loginScreen');
            const dashboard = document.getElementById('dashboardLayout');

            if (session) {
                // --- JIKA LOGIN SUKSES ---
                
                // Hapus Login Screen dari DOM sepenuhnya (Anti-Inspect)
                if(loginScreen) loginScreen.remove();
                
                // Tampilkan Dashboard
                if(dashboard) {
                    dashboard.classList.remove('hidden');
                    dashboard.classList.add('flex');
                }
                
                // Load data
                loadProjectList(); 
                loadLinks(); 
                loadCurrentPopup();
                loadShortlinks();
                setupLivePreview();
                setupDragAndDrop(); 

            } else {
                // --- JIKA TIDAK ADA SESI (GUEST) ---
                
                // HAPUS DASHBOARD DARI DOM SEPENUHNYA!
                // Hacker tidak bisa memunculkan kembali elemen yang sudah dihapus.
                if(dashboard) dashboard.remove();
                
                // Pastikan login screen terlihat
                if(loginScreen) loginScreen.classList.remove('hidden');
            }
        }

        // 2. Verifikasi Sesi Aktif (Gatekeeper untuk setiap tombol)
        async function verifyActiveSession() {
            if(!sb) return false;
            const { data: { session } } = await sb.auth.getSession();
            if (!session) {
                alert("AKSES DITOLAK: Sesi Anda telah berakhir. Halaman akan dimuat ulang.");
                window.location.reload(); // Paksa refresh agar dashboard dihapus lagi
                return false;
            }
            return true;
        }

// --- HELPER FUNCTION ---
        function getPathFromUrl(url) {
            if (!url) return null;
            const bucketName = 'portfolio-images'; 
            const targetStr = `/public/${bucketName}/`;
            const parts = url.split(targetStr);
            return parts.length > 1 ? parts[1] : null;
        }

        // --- SECURITY: FILE VALIDATOR (Paste Kode Baru Di Sini) ---
        function validateFileSecurity(file) {
            // 1. Cek Ukuran (Maks 5MB)
            const maxSize = 5 * 1024 * 1024; // 5MB
            if (file.size > maxSize) {
                throw new Error(`File ${file.name} terlalu besar (Max 5MB).`);
            }

            // 2. Cek Tipe MIME (Harus Image)
            const allowedTypes = ['image/jpeg', 'image/png', 'image/webp', 'image/gif', 'image/svg+xml'];
            if (!allowedTypes.includes(file.type)) {
                throw new Error(`GUDUK ${file.name} KUDU JPG/PNG/WEBP BOSS.`);
            }
            
            return true;
        }

        // --- LIVE PREVIEW LOGIC ---
        function setupLivePreview() {
            const titleInput = document.getElementById('popTitle');
            if(titleInput) {
                titleInput.addEventListener('input', (e) => { document.getElementById('prevTitle').textContent = e.target.value || "Title"; });
                document.getElementById('popTag').addEventListener('input', (e) => { document.getElementById('prevTag').textContent = e.target.value || "TAG"; });
                document.getElementById('popDesc').addEventListener('input', (e) => { document.getElementById('prevDesc').textContent = e.target.value || "Description..."; });
                document.getElementById('popImage').addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (e) => { document.getElementById('currentPopPreview').style.backgroundImage = `url('${e.target.result}')`; }
                        reader.readAsDataURL(file);
                    }
                });
            }
        }

        // --- DRAG AND DROP LOGIC ---
        function setupDragAndDrop() {
            if(typeof Sortable === 'undefined') return;
            
            const projBody = document.getElementById('projectTableBody');
            if(projBody) {
                new Sortable(projBody, {
                    animation: 150, handle: '.drag-handle', ghostClass: 'sortable-ghost', dragClass: 'sortable-drag',
                    onEnd: function (evt) { updateOrder('projects', 'projectTableBody'); }
                });
            }

            const linkBody = document.getElementById('linkTableBody');
            if(linkBody) {
                new Sortable(linkBody, {
                    animation: 150, handle: '.drag-handle', ghostClass: 'sortable-ghost', dragClass: 'sortable-drag',
                    onEnd: function (evt) { updateOrder('links', 'linkTableBody'); }
                });
            }
        }

        async function updateOrder(tableName, tbodyId) {
            if (!await verifyActiveSession()) return; // Security Check
            const rows = document.getElementById(tbodyId).querySelectorAll('tr');
            try {
                for (let index = 0; index < rows.length; index++) {
                    const row = rows[index];
                    const id = row.getAttribute('data-id');
                    if (id) {
                        await sb.from(tableName).update({ sort_order: index }).eq('id', parseInt(id));      
                    }
                }
            } catch (err) { console.error("Error order:", err); }
        }

        // --- AUTH HANDLERS ---
        async function handleLogin() {
            const email = document.getElementById('emailInput').value;
            const status = document.getElementById('loginStatus');
            document.getElementById('btnLogin').innerText = "Sending...";
            const { error } = await sb.auth.signInWithOtp({ email });
            status.innerText = error ? error.message : "Magic Link sent! Check your inbox.";
            status.className = error ? "text-center text-xs mt-6 text-red-400" : "text-center text-xs mt-6 text-green-400 font-bold";
            document.getElementById('btnLogin').innerText = "Send Magic Link";
        }
        async function handleLogout() { await sb.auth.signOut(); window.location.reload(); }

        // --- UX HELPERS ---
       async function switchTab(t) {
            // [SECURITY] Cek sesi dulu ke server sebelum pindah menu
            if (!await verifyActiveSession()) return; 

            // 1. Sembunyikan semua section
            document.querySelectorAll('.section-content').forEach(e => e.classList.add('hidden'));
            
            // 2. Reset Style Tombol Navigasi
            document.querySelectorAll('.nav-btn').forEach(b => {
                b.classList.remove('bg-white/5', 'text-studio-gold', 'border', 'border-studio-gold/20', 'shadow-lg');
                b.classList.add('text-gray-500', 'hover:text-white', 'hover:bg-white/5');
            });
            
            // 3. Tampilkan Section yang dipilih
            const targetSection = document.getElementById('section-'+t);
            if(targetSection) targetSection.classList.remove('hidden');
            
            // 4. Highlight Tombol Aktif
            const activeBtn = document.getElementById('nav-'+t);
            if(activeBtn) {
                activeBtn.classList.remove('text-gray-500', 'hover:text-white', 'hover:bg-white/5');
                activeBtn.classList.add('bg-white/5', 'text-studio-gold', 'border', 'border-studio-gold/20', 'shadow-lg');
            }
        }

        // --- PORTFOLIO LOGIC ---
        async function loadProjectList() {
            const tbody = document.getElementById('projectTableBody');
            const { data } = await sb.from('projects').select('*').order('sort_order', { ascending: true });
            
            if(data && data.length) {
                tbody.innerHTML = data.map(p => `
                    <tr data-id="${p.id}" class="hover:bg-white/5 transition-all group border-b border-white/5 last:border-0">
                        <td class="px-3 py-4 md:px-6 md:py-5 text-center"><i class="fa-solid fa-grip-lines drag-handle text-base md:text-lg opacity-50 hover:opacity-100 p-2"></i></td>
                        <td class="px-3 py-4 md:px-6 md:py-5 text-gray-500 text-[10px] md:text-xs font-mono">${new Date(p.created_at).toLocaleDateString()}</td>
                        <td class="px-3 py-4 md:px-6 md:py-5">
                            <span class="block text-white font-serif italic text-base md:text-lg group-hover:text-studio-gold transition-colors">${p.title}</span>
                            <span class="inline-block mt-1 text-[8px] md:text-[9px] text-gray-400 border border-white/10 px-2 py-0.5 rounded uppercase tracking-wider">${p.category}</span>
                            <span class="text-[9px] md:text-[10px] text-gray-600 font-mono ml-2 hidden md:inline">/${p.slug}</span>
                        </td>
                        <td class="px-3 py-4 md:px-6 md:py-5 text-right"><button onclick="deleteProject(${p.id}, '${p.title.replace(/'/g, "\\'")}')" class="text-gray-600 hover:text-red-400 p-2 transition-colors rounded-full hover:bg-white/5"><i class="fa-regular fa-trash-can"></i></button></td>
                    </tr>
                `).join('');
            } else { tbody.innerHTML = `<tr><td colspan="4" class="text-center py-12 text-gray-600 italic font-serif text-xs md:text-sm">Your portfolio is currently empty.</td></tr>`; }
        }

        document.getElementById('uploadForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!await verifyActiveSession()) return; // Security Check 1: Session

            const btn = document.getElementById('btnSubmit'); 
            const status = document.getElementById('status');
            btn.disabled = true; 
            btn.textContent = "UPLOADING...";
            
            try {
                const files = document.getElementById('photos').files;
                if(files.length===0) throw new Error("Please select photos");
                
                // Security Check 2: Validasi File SEBELUM Upload
                for (let f of files) {
                    validateFileSecurity(f);
                }

                const { count } = await sb.from('projects').select('*', { count: 'exact', head: true });
                const newOrder = count ? count : 0;

                const { data: proj, error: pe } = await sb.from('projects').insert([{ 
                    title: document.getElementById('title').value, 
                    slug: document.getElementById('slug').value, 
                    category: document.getElementById('category').value,
                    sort_order: newOrder
                }]).select();
                
                if(pe) throw pe;

                for(let f of files) {
                    const name = `${document.getElementById('slug').value}/${Date.now()}-${f.name.replace(/[^a-zA-Z0-9.]/g, '_')}`;
                    await sb.storage.from('portfolio-images').upload(name, f);
                    const {data: url} = sb.storage.from('portfolio-images').getPublicUrl(name);
                    await sb.from('project_images').insert([{ 
                        project_id: proj[0].id, 
                        image_url: url.publicUrl, 
                        aspect_ratio: await getImageAspectRatio(f) 
                    }]);
                }
                status.innerText = "PROJECT PUBLISHED SUCCESSFULLY!"; 
                setTimeout(() => status.innerText="", 3000);
                document.getElementById('uploadForm').reset(); 
                loadProjectList();

            } catch(er) { 
                status.innerText = "ERROR: " + er.message; 
                status.classList.add('text-red-400'); 
            } finally { 
                btn.disabled = false; 
                btn.textContent = "Publish Project"; 
            }
        });

        async function deleteProject(id, title) {
            if (!await verifyActiveSession()) return; // SECURITY CHECK
            if (!confirm(`Permanently delete project: ${title} and all its images?`)) return;

            try {
                const { data: images, error: fetchError } = await sb.from('project_images').select('image_url').eq('project_id', id);
                if (fetchError) throw fetchError;

                if (images && images.length > 0) {
                    const pathsToDelete = images.map(img => getPathFromUrl(img.image_url)).filter(path => path !== null);
                    if (pathsToDelete.length > 0) await sb.storage.from('portfolio-images').remove(pathsToDelete);
                }

                const { error: deleteError } = await sb.from('projects').delete().eq('id', id);
                if (deleteError) throw deleteError;

                loadProjectList();
                alert("Project dan file gambar berhasil dihapus bersih!");
            } catch (err) { console.error(err); alert("Gagal menghapus: " + err.message); }
        }

        // --- LINKTREE LOGIC ---
        async function loadLinks() {
            const tbody = document.getElementById('linkTableBody');
            const { data } = await sb.from('links').select('*').order('sort_order', { ascending: true });
            if(data && data.length) {
                tbody.innerHTML = data.map(i => `
                    <tr data-id="${i.id}" class="hover:bg-white/5 border-b border-white/5 last:border-0 transition-colors group">
                        <td class="px-3 py-4 md:px-6 md:py-4 text-center"><i class="fa-solid fa-grip-lines drag-handle opacity-50 hover:opacity-100 p-2"></i></td>
                        <td class="px-3 py-4 md:px-6 md:py-4 flex gap-3 md:gap-4 items-center">
                            <div class="w-6 h-6 md:w-8 md:h-8 rounded bg-white/5 flex items-center justify-center text-studio-gold flex-shrink-0"><i class="${i.icon} text-xs md:text-sm"></i></div>
                            <div><span class="block text-white text-xs md:text-sm font-medium">${i.label_id}</span><span class="block text-[9px] md:text-[10px] text-gray-500">${i.label_en}</span></div>
                        </td>
                        <td class="px-3 py-4 md:px-6 md:py-4 text-[10px] md:text-xs text-blue-400/80 truncate max-w-[100px] md:max-w-[150px] font-mono hover:text-blue-400">${i.url}</td>
                        <td class="px-3 py-4 md:px-6 md:py-4 text-right"><button onclick="deleteLink(${i.id})" class="text-gray-600 hover:text-red-400 p-2 rounded-full hover:bg-white/5 transition-colors"><i class="fa-regular fa-trash-can"></i></button></td>
                    </tr>
                `).join('');
            } else { tbody.innerHTML = `<tr><td colspan="4" class="text-center py-12 text-gray-600 italic font-serif text-xs">No active links found.</td></tr>`; }
        }

        document.getElementById('linkForm').addEventListener('submit', async(e) => {
            e.preventDefault();
            if (!await verifyActiveSession()) return; // SECURITY CHECK
            const { count } = await sb.from('links').select('*', { count: 'exact', head: true });
            const newOrder = count ? count : 0;
            const { error } = await sb.from('links').insert([{
                label_id: document.getElementById('linkLabelID').value, label_en: document.getElementById('linkLabelEN').value,
                url: document.getElementById('linkURL').value, icon: document.getElementById('linkIcon').value, sort_order: newOrder
            }]);
            if(error) alert(error.message); else { document.getElementById('linkForm').reset(); loadLinks(); }
        });

        async function deleteLink(id) { 
            if (!await verifyActiveSession()) return; // SECURITY CHECK
            if(confirm('Remove this link?')) { await sb.from('links').delete().eq('id', id); loadLinks(); } 
        }

        // --- POPUP LOGIC ---
        async function loadCurrentPopup() {
            const { data } = await sb.from('popups').select('*').order('created_at', {ascending: false}).limit(1);
            if(data && data.length > 0) {
                const p = data[0];
                document.getElementById('currentPopPreview').style.backgroundImage = `url('${p.image_url}')`;
                document.getElementById('prevTag').innerText = p.tag; document.getElementById('prevTitle').innerText = p.title; document.getElementById('prevDesc').innerText = p.description;
                document.getElementById('popTitle').value = p.title; document.getElementById('popTag').value = p.tag; document.getElementById('popDesc').value = p.description;
            }
        }
        
        document.getElementById('popupForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!await verifyActiveSession()) return; // Security Check 1

            const btn = document.getElementById('btnPopSubmit'); 
            const status = document.getElementById('popStatus');
            btn.disabled = true; 
            btn.innerText = "UPLOADING...";
            
            try {
                const file = document.getElementById('popImage').files[0];
                let imageUrl = "";
                
                if(file) {
                    // Security Check 2: Validasi File
                    validateFileSecurity(file);

                    // Remove Old Popup Image logic...
                    const { data: oldPopup } = await sb.from('popups').select('image_url').order('created_at', { ascending: false }).limit(1);
                    if (oldPopup && oldPopup.length > 0) {
                        const oldPath = getPathFromUrl(oldPopup[0].image_url);
                        if (oldPath) await sb.storage.from('portfolio-images').remove([oldPath]);
                    }
                    
                    const name = `popup/${Date.now()}-${file.name.replace(/[^a-zA-Z0-9.]/g, '_')}`;
                    await sb.storage.from('portfolio-images').upload(name, file);
                    const {data} = sb.storage.from('portfolio-images').getPublicUrl(name);
                    imageUrl = data.publicUrl;
                } else {
                    const { data } = await sb.from('popups').select('image_url').order('created_at', {ascending: false}).limit(1);
                    if(data.length) imageUrl = data[0].image_url; 
                }
                
                await sb.from('popups').insert([{ 
                    title: document.getElementById('popTitle').value, 
                    tag: document.getElementById('popTag').value, 
                    description: document.getElementById('popDesc').value, 
                    image_url: imageUrl 
                }]);
                
                status.innerText = "POPUP UPDATED SUCCESSFULLY!"; 
                document.getElementById('popupForm').reset(); 
                loadCurrentPopup();

            } catch(er) { 
                alert(er.message); 
            } finally { 
                btn.disabled = false; 
                btn.innerText = "Set Active Popup"; 
                setTimeout(() => status.innerText="", 3000); 
            }
        });

        // --- IMAGE CONVERTER LOGIC ---
        function updateConvLabel(input) {
            const label = document.getElementById('convLabel');
            label.textContent = input.files.length > 0 ? `${input.files.length} images ready to process` : "Select Images to Convert";
            label.classList.toggle('text-studio-gold', input.files.length > 0);
        }

        async function processConversion() {
            const input = document.getElementById('convInput'); const files = input.files;
            const btn = document.getElementById('btnConvert'); const status = document.getElementById('convStatus');
            const maxWidth = parseInt(document.getElementById('convWidth').value) || 1920; const quality = parseFloat(document.getElementById('convQuality').value) || 0.8;

            if (files.length === 0) { alert("Please select images first!"); return; }
            btn.disabled = true; btn.innerHTML = `<i class="fa-solid fa-circle-notch fa-spin mr-2"></i> PROCESSING...`;
            
            const zip = new JSZip();
            try {
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    status.innerText = `Processing ${i + 1}/${files.length}: ${file.name}`;
                    const blob = await convertToWebP(file, maxWidth, quality);
                    const newName = file.name.replace(/\.[^/.]+$/, "") + ".webp";
                    zip.file(newName, blob);
                }
                status.innerText = "Zipping files...";
                const content = await zip.generateAsync({type: "blob"});
                saveAs(content, `aksara-optimized-${Date.now()}.zip`);
                status.innerText = "DONE! Download started."; status.className = "text-center text-[10px] text-green-400 font-mono mt-2";
                input.value = ""; updateConvLabel(input);
            } catch (error) { console.error(error); status.innerText = "Error: " + error.message; status.className = "text-center text-[10px] text-red-400 font-mono mt-2"; } 
            finally { btn.disabled = false; btn.innerHTML = `<i class="fa-solid fa-bolt mr-2"></i> Convert & Download ZIP`; setTimeout(() => { status.innerText = ""; }, 5000); }
        }

        function convertToWebP(file, maxWidth, quality) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        let width = img.width; let height = img.height;
                        if (width > maxWidth) { height = Math.round(height * (maxWidth / width)); width = maxWidth; }
                        const canvas = document.createElement('canvas');
                        canvas.width = width; canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        canvas.toBlob((blob) => { if (blob) resolve(blob); else reject(new Error("Conversion failed")); }, 'image/webp', quality);
                    };
                    img.onerror = (e) => reject(e);
                };
                reader.onerror = (e) => reject(e);
            });
        }

        // --- SHORTLINK LOGIC ---
        async function loadShortlinks() {
            const tbody = document.getElementById('shortlinkTableBody');
            const { data, error } = await sb.from('shortlinks').select('*').order('created_at', { ascending: false });
            if (error) { console.error(error); return; }

            if (data && data.length) {
                const domain = "aksara-picture-mlg.vercel.app/";
                tbody.innerHTML = data.map(item => `
                    <tr class="hover:bg-white/5 border-b border-white/5 last:border-0 transition-colors group">
                        <td class="px-3 py-4 md:px-6 md:py-4"><div class="flex items-center gap-3"><span class="text-studio-gold font-bold font-mono text-xs md:text-sm">/${item.slug}</span><button onclick="copyToClipboard('${domain}${item.slug}')" class="text-gray-600 hover:text-white text-[10px] transition-colors"><i class="fa-regular fa-copy"></i></button></div></td>
                        <td class="px-3 py-4 md:px-6 md:py-4 text-[10px] md:text-xs text-gray-500 truncate max-w-[200px] font-mono">${item.original_url}</td>
                        <td class="px-3 py-4 md:px-6 md:py-4 text-center font-mono text-xs text-white/50">${item.clicks || 0}</td>
                        <td class="px-3 py-4 md:px-6 md:py-4 text-right"><button onclick="deleteShortlink(${item.id})" class="text-gray-600 hover:text-red-400 p-2 rounded-full hover:bg-white/5 transition-colors"><i class="fa-regular fa-trash-can"></i></button></td>
                    </tr>
                `).join('');
            } else { tbody.innerHTML = `<tr><td colspan="4" class="text-center py-12 text-gray-600 italic font-serif text-xs">No active shortlinks.</td></tr>`; }
        }

        document.getElementById('shortlinkForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!await verifyActiveSession()) return; // SECURITY CHECK

            const btn = e.target.querySelector('button[type="submit"]');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Saving...'; btn.disabled = true;
            const slug = document.getElementById('slSlug').value.trim(); const url = document.getElementById('slUrl').value.trim();
            try {
                const { data: existing } = await sb.from('shortlinks').select('id').eq('slug', slug).single();
                if (existing) throw new Error("Slug '"+slug+"' is already taken.");
                const { error } = await sb.from('shortlinks').insert([{ slug: slug, original_url: url }]);
                if (error) throw error;
                document.getElementById('shortlinkForm').reset(); loadShortlinks();
            } catch (err) { alert("Error: " + err.message); } finally { btn.innerHTML = originalText; btn.disabled = false; }
        });

        async function deleteShortlink(id) {
            if (!await verifyActiveSession()) return; // SECURITY CHECK
            if (confirm('Permanently delete this shortlink?')) { await sb.from('shortlinks').delete().eq('id', id); loadShortlinks(); }
        }

        function copyToClipboard(text) { navigator.clipboard.writeText("https://" + text).then(() => { alert("Link copied: https://" + text); }); }
        
        // --- AUTO LOGOUT (IDLE TIMER) ---
        let idleTime = 0;
        function resetTimer() { idleTime = 0; }
        document.onmousemove = resetTimer;
        document.onkeypress = resetTimer;

        setInterval(async function() {
            idleTime++; 
            if (idleTime >= 30) { // 30 Menit diam
                await sb.auth.signOut();
                alert("Sesi berakhir karena tidak ada aktivitas.");
                window.location.reload();
            }
        }, 60000); // Cek tiap 1 menit
        
        checkSession();
    </script>
</body>
</html>